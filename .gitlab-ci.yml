image: node:22.12

stages:
  - build
  - test
  - image
  - deploy

variables:
  BACKEND_IMAGE: "$CI_REGISTRY_IMAGE/backend"
  FRONTEND_IMAGE: "$CI_REGISTRY_IMAGE/frontend"
  # immutable tag per pipeline
  IMAGE_TAG: "$CI_COMMIT_SHA"
  # moving tag per branch
  BRANCH_TAG: "$CI_COMMIT_REF_SLUG"

build-frontend:
  stage: build
  script:
    - cd frontend/vue-project
    - npm install
    - export VITE_API_BASE_URL="/"
    - npm run build
  artifacts:
    expire_in: 1 hour
    paths:
      - frontend/vue-project/dist
  only:
    - branches
    - merge_requests

backend-test:
  image: python:3.11
  stage: test
  script:
    - cd backend
    - python -m venv .venv
    - . .venv/bin/activate
    - pip install -r requirements.txt
    - python -m pytest
  only:
    - branches
    - merge_requests

playwright-e2e:
  stage: test
  image: mcr.microsoft.com/playwright:v1.56.1-jammy
  services: 
  # same workflow as whipping up the entire program locally, definitely easier way to do it but idk
    # Postgres
    - name: postgres:17
      alias: db
      variables:
        POSTGRES_DB: "catdb"
        POSTGRES_USER: "user"
        POSTGRES_PASSWORD: "password"
    # MinIO
    - name: minio/minio:latest
      alias: minio
      command: ["server", "/data", "--console-address", ":9001"]
      variables:
        MINIO_ROOT_USER: "minioadmin"
        MINIO_ROOT_PASSWORD: "minioadmin"
  variables: # not sensitive since its just localized testing
    DATABASE_URL: "postgresql+psycopg://user:password@db:5432/catdb"
    MINIO_ENDPOINT: "minio:9000"
    MINIO_ACCESS_KEY: "minioadmin"
    MINIO_SECRET_KEY: "minioadmin"
  needs:
    - build-frontend
    - backend-test
  script:
    # python for backend
    - apt-get update
    - apt-get install -y python3 python3-venv python3-pip

    # decode SMTP password for testing
    - SMTP_PASSWORD_DECODED=$(printf '%s' "$SMTP_PASSWORD" | base64 -d)

    # start backend 
    - cd backend
    - python3 -m venv .venv
    - . .venv/bin/activate
    - pip install -r requirements.txt
    - DATABASE_URL="postgresql+psycopg://user:password@db:5432/catdb" MINIO_ENDPOINT="minio:9000" MINIO_ACCESS_KEY="minioadmin" MINIO_SECRET_KEY="minioadmin" SMTP_HOST="$SMTP_HOST" SMTP_PORT="587" SMTP_USERNAME="$SMTP_USERNAME" SMTP_PASSWORD="$SMTP_PASSWORD_DECODED" SMTP_FROM="$SMTP_FROM" uvicorn app.main:app --host 0.0.0.0 --port 8000 &
    - BACKEND_PID=$!
    - cd ..

    # start frontend
    - cd frontend/vue-project
    - npm install
    - npm run dev -- --host 0.0.0.0 --port 8081 &
    - FRONTEND_PID=$!

    - sleep 15

    # install playwright 
    - npx playwright install --with-deps

    # run e2e
    - BASE_URL="http://localhost:8081" npx playwright test
  after_script:
    - kill $BACKEND_PID || true
    - kill $FRONTEND_PID || true
  only:
    - branches
    - merge_requests


# build + push docker images with buildkit
image:build-push:
  image:
    name: moby/buildkit:rootless
    entrypoint: [""]
  stage: image
  variables:
    DOCKER_CONFIG: "$CI_PROJECT_DIR/.docker"
    BUILDKITD_FLAGS: "--oci-worker-no-process-sandbox"
  script:
    - mkdir -p "$DOCKER_CONFIG"
    - AUTH_B64=$(printf "%s:%s" "$CI_REGISTRY_USER" "$CI_REGISTRY_PASSWORD" | base64 | tr -d '\n')
    - |
      cat > "$DOCKER_CONFIG/config.json" <<EOF
      {
        "auths": {
          "$CI_REGISTRY": { "auth": "$AUTH_B64" }
        }
      }
      EOF

    # frontend image (immutable tag)
    - |
      buildctl-daemonless.sh build \
        --frontend dockerfile.v0 \
        --local context=frontend/vue-project \
        --local dockerfile=frontend/vue-project \
        --output type=image,name=${FRONTEND_IMAGE}:${IMAGE_TAG},push=true

    # frontend image (moving branch tag)
    - |
      buildctl-daemonless.sh build \
        --frontend dockerfile.v0 \
        --local context=frontend/vue-project \
        --local dockerfile=frontend/vue-project \
        --output type=image,name=${FRONTEND_IMAGE}:${BRANCH_TAG},push=true

    # backend image (immutable tag)
    - |
      buildctl-daemonless.sh build \
        --frontend dockerfile.v0 \
        --local context=backend \
        --local dockerfile=backend \
        --output type=image,name=${BACKEND_IMAGE}:${IMAGE_TAG},push=true

    # backend image (moving branch tag)
    - |
      buildctl-daemonless.sh build \
        --frontend dockerfile.v0 \
        --local context=backend \
        --local dockerfile=backend \
        --output type=image,name=${BACKEND_IMAGE}:${BRANCH_TAG},push=true
  needs:
    - build-frontend
    - backend-test
    - playwright-e2e
  only:
    - branches
    - merge_requests

# 4) deploy server (with shell runner)
deploy-prod:
  stage: deploy
  tags:
    - catdb-deploy
  only:
    - main
  script:
    # 1. login to gitlab registry on the server
    - docker login "$CI_REGISTRY" -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD"

    # 2. pull freshly built images (use immutable tag)
    - docker pull ${FRONTEND_IMAGE}:${IMAGE_TAG}
    - docker pull ${BACKEND_IMAGE}:${IMAGE_TAG}

    # 3. stop old containers
    - docker rm -f catdb-frontend || true
    - docker rm -f catdb-backend || true

    # decode SMTP password from base64
    - SMTP_PASSWORD_DECODED=$(printf '%s' "$SMTP_PASSWORD" | base64 -d)

    # 4. start backend
    - >
      docker run -d --name catdb-backend --network cat_default
      -e DATABASE_URL="$CATDB_DATABASE_URL"
      -e MINIO_ENDPOINT="minio:9000"
      -e MINIO_ACCESS_KEY="$CATDB_MINIO_ACCESS_KEY"
      -e MINIO_SECRET_KEY="$CATDB_MINIO_SECRET_KEY"
      -e SMTP_HOST="$SMTP_HOST"
      -e SMTP_PORT="587"
      -e SMTP_USERNAME="$SMTP_USERNAME"
      -e SMTP_PASSWORD="$SMTP_PASSWORD_DECODED"
      -e SMTP_FROM="$SMTP_FROM"
      ${BACKEND_IMAGE}:${IMAGE_TAG}

    # 5. start frontend
    - docker run -d --name catdb-frontend --network cat_default ${FRONTEND_IMAGE}:${IMAGE_TAG}
  environment:
    name: production
  needs:
    - image:build-push